<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª | AllamTechno</title>
<link rel="stylesheet" href="app.css">
<script src="config.js"></script>
<script src="dev.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
if(!firebase.apps.length) firebase.initializeApp(window.AT_FIREBASE_CONFIG);
const db = firebase.firestore();
firebase.auth().onAuthStateChanged(function(u){ if(!u){ location.href='login.html'; } });
</script>

<script>
(function(){
  const url = new URL(location.href);
  if (url.searchParams.get('dev') === '1'){ localStorage.setItem('AT_DEV_ENABLED','1'); }
  document.addEventListener('DOMContentLoaded', function(){
    if (window.__AT_DEV__) window.__AT_DEV__.applyDevVisibility();
  });
})();
</script>

</head>
<body>
<div class="topbar"><div><b>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</b></div><div><a class="button" href="dashboard.html">Ø±Ø¬ÙˆØ¹</a></div></div>
<div class="layout">
  <aside class="sidebar">
    <nav class="menu">
      <a href="dashboard.html">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <a href="orders.html">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
      <a href="drivers.html">ğŸš— Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†</a>
      <a href="companies.html">ğŸ¢ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„ØªØ¹Ø§Ù‚Ø¯Ø§Øª</a>
      <a href="accounts.html" class="active">ğŸ’° Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</a>
      <a href="reports.html">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
      <a href="settings.html">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
    </nav>
  </aside>
  <main class="content">
    <section class="card">
      <h3>ØªØ³Ø¬ÙŠÙ„ ØªØ³ÙˆÙŠØ§Øª COD</h3>
      <div class="grid" style="grid-template-columns:repeat(4, minmax(0,1fr)); gap:10px">
        <input id="s_driver" class="input" placeholder="ID Ø§Ù„Ø³Ø§Ø¦Ù‚">
        <input id="s_amount" class="input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input id="s_ref" class="input" placeholder="Ù…Ø±Ø§Ø¬Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <button class="button" id="btnSaveSettle">Ø­ÙØ¸</button>
      </div>
    </section>

    <section class="card">
      <h3>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¹Ù…ÙŠÙ„</h3>
      <div class="grid" style="grid-template-columns:repeat(5, minmax(0,1fr)); gap:10px">
        <input id="inv_client" class="input" placeholder="ID Ø§Ù„Ø¹Ù…ÙŠÙ„">
        <input id="inv_from" class="input" placeholder="Ù…Ù† (YYYY-MM-DD)">
        <input id="inv_to" class="input" placeholder="Ø¥Ù„Ù‰ (YYYY-MM-DD)">
        <input id="inv_rate" class="input" placeholder="Ø³Ø¹Ø±/Ø·Ù„Ø¨ (ÙÙŠ Ø­Ø§Ù„ per_order)">
        <button class="button" id="btnBuildInvoice">ØªØ¬Ù‡ÙŠØ²</button>
      </div>
      <div style="margin-top:10px">
        <button class="button" id="btnExportCsv">ØªØµØ¯ÙŠØ± CSV</button>
      </div>
      <table class="table" id="tblInv"><thead><tr><th>OrderID</th><th>Client</th><th>Status</th><th>DistanceKm</th><th>Amount</th></tr></thead><tbody></tbody></table>
      <div id="invTotal" style="margin-top:8px;font-weight:700"></div>
    </section>

    <section class="card">
      <h3>Ø³Ø¬Ù„ ØªØ³ÙˆÙŠØ§Øª COD</h3>
      <table class="table" id="tblSettle"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø³Ø§Ø¦Ù‚</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ø±Ø¬Ø¹</th></tr></thead><tbody></tbody></table>
    </section>
  </main>
</div>

<script>
function el(id){ return document.getElementById(id); }

el('btnSaveSettle').onclick = async () => {
  const doc = {
    driverId: el('s_driver').value.trim(),
    amount: parseFloat(el('s_amount').value||0),
    ref: el('s_ref').value.trim()||null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  if(!doc.driverId || !doc.amount){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù…Ø¨Ù„Øº'); return; }
  await db.collection('cod_settlements').add(doc);
  alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³ÙˆÙŠØ©');
  loadSettle();
};

let invoiceRows = [];
el('btnBuildInvoice').onclick = async () => {
  const clientId = el('inv_client').value.trim();
  const from = new Date(el('inv_from').value.trim());
  const to = new Date(el('inv_to').value.trim());
  const rate = parseFloat(el('inv_rate').value||0);
  if(!clientId || !el('inv_from').value || !el('inv_to').value){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

  const snap = await db.collection('orders').where('clientId','==', clientId).get();
  invoiceRows = [];
  snap.forEach(d=>{
    const o = d.data();
    const ts = o.createdAt ? new Date(o.createdAt.seconds*1000) : null;
    if(!ts || ts<from || ts>to) return;
    const amount = o.amount || (o.status==='delivered' ? (rate||0) : 0);
    invoiceRows.push({id:d.id, client: clientId, status: o.status||'', distanceKm: o.distanceKm||0, amount});
  });

  // render
  const tbody = document.querySelector('#tblInv tbody'); tbody.innerHTML='';
  let total = 0;
  invoiceRows.forEach(r=>{ total += r.amount||0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.id}</td><td>${r.client}</td><td>${r.status}</td><td>${r.distanceKm}</td><td>${r.amount.toFixed(3)}</td>`;
    tbody.appendChild(tr);
  });
  el('invTotal').textContent = 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + total.toFixed(3);
};

el('btnExportCsv').onclick = () => {
  if(!invoiceRows.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
  const rows = [['OrderID','Client','Status','DistanceKm','Amount']].concat(invoiceRows.map(r=>[r.id,r.client,r.status,r.distanceKm,r.amount]));
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='invoice.csv'; a.click();
  URL.revokeObjectURL(url);
};

async function loadSettle(){
  const tbody = document.querySelector('#tblSettle tbody'); tbody.innerHTML='';
  const snap = await db.collection('cod_settlements').orderBy('createdAt','desc').limit(200).get();
  snap.forEach(d=>{
    const s = d.data();
    const tr = document.createElement('tr');
    const dt = s.createdAt ? new Date(s.createdAt.seconds*1000).toLocaleString('ar-EG') : '-';
    tr.innerHTML = `<td>${dt}</td><td>${s.driverId}</td><td>${(s.amount||0).toFixed(3)}</td><td>${s.ref||''}</td>`;
    tbody.appendChild(tr);
  });
}
document.addEventListener('DOMContentLoaded', loadSettle);
</script>
</body></html>
